<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>D√©bat ‚Äì Belles-Terres (d√©mo)</title>
<style>
body{font:16px/1.4 system-ui,Segoe UI,Arial;margin:0;background:#0b0b0c;color:#f3f3f3}
header,footer{padding:12px 16px;background:#121214}
main{max-width:820px;margin:0 auto;padding:12px 16px}
.card{background:#18181b;border:1px solid #2a2a2e;border-radius:12px;padding:12px 14px;margin:10px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
label{opacity:.85}
select,textarea,input,button{border-radius:10px;border:1px solid #2a2a2e;background:#101014;color:#f3f3f3}
textarea{width:100%;min-height:70px;padding:10px}
input,select{padding:8px}
button{padding:10px 14px;cursor:pointer}
.msg{white-space:pre-wrap}
.user{border-left:4px solid #4ea1ff;padding-left:10px}
.bot{border-left:4px solid #7ee787;padding-left:10px}
small{opacity:.75}
</style>
</head>
<body>
<header><h1>Forum des Belles-Terres ‚Äî D√©mo bot en personnage</h1></header>
<main>
  <div class="card">
    <div class="row">
      <label>Persona&nbsp;</label>
      <select id="persona">
        <option value="elyo">√âlyo ‚Äî apprenti technicien √©olien</option>
        <option value="nae">Na√© ‚Äî apprentie chamane</option>
        <option value="mika">Mika ‚Äî employ√©¬∑e Creuser-Puiser</option>
        <option value="lia">Lia ‚Äî Libert√© & Nature</option>
        <option value="teo">T√©o ‚Äî p√™che & chevaux tradition</option>
      </select>
      <label>&nbsp;&nbsp;Voix</label>
      <input type="checkbox" id="tts" />
      <small>Lire les r√©ponses √† voix haute</small>
    </div>
    <div style="margin-top:8px">
      <label>Contexte du monde (√©ditable, partag√© au bot)</label>
      <textarea id="world"></textarea>
    </div>
  </div>

  <div id="chat"></div>

  <div class="card">
    <textarea id="input" placeholder="√âcris ta r√©ponse ou ton id√©e‚Ä¶"></textarea>
    <div class="row" style="justify-content:space-between;margin-top:6px">
      <div>
        <button id="send">Envoyer</button>
        <button id="reset">R√©initialiser</button>
      </div>
      <small>Astuce : le bot suit un format stable (üëç ‚ÑπÔ∏è ‚ùì ‚úçÔ∏è) et pose max 1‚Äì2 questions.</small>
    </div>
  </div>
</main>
<footer><small>D√©mo √©ducative (HarmoS 7‚Äì11). Le personnage reste en-monde et bienveillant.</small></footer>

<script>
const API_URL = "https://dark-rice-25ee.nicolas-tuor.workers.dev/api/chat";
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const personaSel = document.getElementById("persona");
const worldEl = document.getElementById("world");
const tts = document.getElementById("tts");

const PERSONAS = {
  elyo: { name:"√âlyo", bio:"apprenti technicien des √©oliennes, curieux et calme (pro-√©olien, attentif aux oiseaux et au paysage)" },
  nae:  { name:"Na√©",  bio:"apprentie chamane des Belles-Terres (prot√®ge les terres sacr√©es, ouverte aux √©oliennes en zones neutres)" },
  mika: { name:"Mika", bio:"employ√©¬∑e local¬∑e de Creuser-Puiser (emplois, mines et √©oliennes locales, veut des garanties environnementales)" },
  lia:  { name:"Lia",  bio:"militante de l‚Äôassociation Libert√© & Nature (pr√©server les biotopes, pro-√©cotourisme, contre mines et √©oliennes)" },
  teo:  { name:"T√©o",  bio:"habitant attach√© √† la p√™che artisanale et aux chevaux (prudent avec tourisme de masse et √©oliennes)" },
};

const DEFAULT_WORLD = {
  lieu: "Forum de parole de la C√¥te-Nord (vents forts)",
  enjeux: ["mines de terres rares (n√©odyme)", "parcs √©oliens c√¥tiers", "√©cotourisme"],
  rappel: "Rester respectueux, √©couter, poser des questions courtes.",
  note: "Les √©l√®ves √©crivent une 'Ma trace' en 1 phrase √† la fin de chaque tour."
};
worldEl.value = JSON.stringify(DEFAULT_WORLD, null, 2);

let history = [
  // Tu peux ins√©rer un message d‚Äôouverture ici si tu veux.
];

function addMsg(role, text) {
  const div = document.createElement("div");
  div.className = "card msg " + (role === "user" ? "user" : "bot");
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  if (role === "assistant" && tts.checked && "speechSynthesis" in window) {
    const u = new SpeechSynthesisUtterance(text.replace(/üëç|‚ÑπÔ∏è|‚ùì|‚úçÔ∏è/g,""));
    u.lang = "fr-CH"; window.speechSynthesis.speak(u);
  }
  // log minimal
  localStorage.setItem("bt_demo_history", JSON.stringify(history));
}

document.getElementById("send").onclick = async () => {
  const content = input.value.trim();
  if (!content) return;
  history.push({ role:"user", content });
  addMsg("user", content);
  input.value = "";

  const persona = PERSONAS[personaSel.value];
  const world = JSON.parse(worldEl.value || "{}");

  const r = await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ messages: history, persona, world })
  });
  const data = await r.json();
  const reply = data.reply || "(pas de r√©ponse)";
  history.push({ role:"assistant", content: reply });
  addMsg("assistant", reply);
};

document.getElementById("reset").onclick = () => {
  history = [];
  chat.innerHTML = "";
  localStorage.removeItem("bt_demo_history");
};

// Restaurer l'historique pr√©c√©dent si pr√©sent
try {
  const prev = JSON.parse(localStorage.getItem("bt_demo_history")||"[]");
  if (prev.length){ history = prev; for (const m of prev) addMsg(m.role==="user"?"user":"assistant", m.content); }
} catch {}
</script>
</body>
</html>
