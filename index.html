<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Belles-Terres — Débat IA (maquette)</title>
  <meta name="description" content="Maquette bot-débat Belles-Terres (éoliennes/énergies)">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 12px 16px; border-bottom: 1px solid #ccc4; display:flex; align-items:center; gap:12px; }
    header h1 { font-size: 18px; margin:0; }
    /* ----- Layout: chat en haut, éditeurs en bas ----- */
    main { display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; }
    .panel { border:1px solid #ccc4; border-radius:12px; padding:12px; background:#fff0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size: 14px; opacity:.9; }
    select, textarea, input[type="text"] { width:100%; padding:8px; border-radius:8px; border:1px solid #9995; background:#fff0; color:inherit; }
    textarea { min-height: 180px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .chat { height: 52vh; min-height: 320px; overflow:auto; display:flex; flex-direction:column; gap:8px; padding:8px; border:1px solid #ccc4; border-radius:12px; background: #0000; }
    .msg { padding:10px 12px; border-radius:10px; white-space:pre-wrap; line-height:1.35; }
    .msg.user { align-self:flex-end; background:#0b5bf533; border:1px solid #0b5bf555; }
    .msg.bot  { align-self:flex-start; background:#14a14a33; border:1px solid #14a14a55; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls > * { flex: none; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #6665; background:#fff0; cursor:pointer; }
    button:hover { background:#6661; }
    .muted { opacity:.7; font-size:12px; }
    select, option { background-color: Canvas; color: CanvasText; }

    /* ----- Panneau à onglets (éditeurs en bas) ----- */
    .tabs { display:flex; gap:8px; border-bottom:1px solid #ccc4; margin-bottom:8px; flex-wrap:wrap; }
    .tab-btn { padding:8px 10px; border:1px solid #ccc4; border-bottom:none; border-radius:8px 8px 0 0; cursor:pointer; background:#fff0; }
    .tab-btn.active { background: color-mix(in srgb, Canvas, CanvasText 4%); }
    .tab { display:none; }
    .tab.active { display:block; }
    .hint { margin-top:6px; }
    /* Avatar persona en haut-droite de la fenêtre de chat */
/* taille de la “case” (change 72px si tu veux plus grand) */
:root { --avatar: 72px; }

.chat-panel { position: relative; }

/* avatar rond, recadré sans déformation */
.persona-avatar{
  position:absolute; top:10px; right:12px;
  width:var(--avatar); height:var(--avatar);
  border-radius:50%;
  object-fit:cover;            /* remplit le cadre sans distorsion */
  object-position:center;      /* recadre au centre */
  border:1px solid #ccc6; box-shadow:0 2px 8px #0002;
}


  </style>
</head>
<body>
  <header>
    <h1> Belles-Terres — bot de relance (maquette)</h1>
    <span class="muted">Démo bot de discusion — éditeurs en bas (Monde / Personas / Prompt)</span>
  </header>

  <main>
    <!-- Zone Chat (haut) -->
<section class="panel chat-panel">
  <img id="avatar" class="persona-avatar" alt="avatar" src="">
      <div class="row" style="gap:12px; margin-bottom:8px;">
        <label>Persona:
          <select id="persona"></select>
        </label>
        <label>Modèle:
          <select id="model">
            <option value="gpt-4o-mini">gpt-4o-mini (recommandé)</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-4.1">gpt-4.1</option>
            <option value="gpt-5">gpt-5</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo (ancien)</option>
          </select>
        </label>
        <label class="row" style="gap:6px;">
          <input type="checkbox" id="tts" />
          <span>Voix (lire les réponses)</span>
        </label>
      </div>

      <div id="chat" class="chat" aria-live="polite"></div>

      <div class="row" style="margin-top:8px; align-items:flex-start;">
        <textarea id="input" placeholder="Propose ton idée, pose une question… (Entrée pour envoyer)"></textarea>
      </div>
      <div class="controls" style="margin-top:8px;">
        <button id="send">Envoyer</button>
        <button id="save">Sauvegarder la session</button>
        <button id="reset">Nouvelle conversation</button>
        <span class="muted">Les logs NDJSON sont enregistrés côté R2 lors du clic “Sauvegarder”.</span>
      </div>
    </section>

    <!-- Panneau éditeurs (bas) -->
    <section class="panel" id="editors">
      <div class="tabs">
  <button class="tab-btn active" data-tab="world-tab">Monde</button>
  <button class="tab-btn" data-tab="personas-tab">Personas.json</button>
  <button class="tab-btn" data-tab="prompt-tab">Prompt (règles)</button>
  <button class="tab-btn" data-tab="questions-tab">Questions</button>
  <button class="tab-btn" data-tab="help-tab">Explications</button>
  <button class="tab-btn" data-tab="feedback-tab">Commentaires</button>

</div>



      <!-- Monde -->
      <div class="tab active" id="world-tab">
        <textarea id="world" spellcheck="false"></textarea>
        <p class="muted hint">
          Source actuelle chargée depuis <code>./data/world.json</code>. Vous pouvez éditer ici pour tester puis copier/coller dans le fichier.
        </p>
      </div>

      <!-- Personas -->
      <div class="tab" id="personas-tab">
        <textarea id="personasEditor" spellcheck="false" placeholder='[ { "id":"gaspard", "name":"Gaspard — Pêche, chevaux et tradition", "bio":"…", "sfxProfile":"male", "piperVoice":"fr_FR-mls-medium", "speaker":5 }, … ]'></textarea>
        <p class="muted hint">
          Éditeur JSON des personas (affichage “Prénom — Groupe”). Fichier source : <code>./data/personas.json</code>.
        </p>
      </div>

      <!-- Prompt (règles) -->
      <div class="tab" id="prompt-tab">
        <textarea id="promptEditor" spellcheck="false" placeholder="// Extrait de assets/prompt.js (fonction makeSystem)…"></textarea>
        <p class="muted hint">
          Règles système/immersion. Fichier source : <code>./assets/prompt.js</code>. (Pour impacter le runtime, il faudra faire lire ce contenu par <code>app.js</code>.)
        </p>
      </div>
      <!-- Questions (banque de relances) -->
<div class="tab" id="questions-tab">
  <textarea id="questionsEditor" spellcheck="false" style="min-height:180px"></textarea>
  <p class="muted hint">
    Éditez la banque de questions/relances par valeur (JSON). Les changements s’appliquent à chaud
    et sont retenus localement. Un JSON invalide est encadré en rouge.
  </p>
</div>

      <!-- Explications -->
<div class="tab" id="help-tab">
  <div id="helpContent" class="doc" style="min-height:180px; border:1px dashed #ccc6; border-radius:8px; padding:8px;">
    <em class="muted">Chargera le guide depuis <code>./docs/README.html</code> au premier clic…</em>
  </div>
  <p class="muted hint">Astuce : éditez librement <code>docs/README.html</code> (HTML simple).</p>
</div>
<!-- Commentaires -->
<div class="tab" id="feedback-tab">
  <textarea id="feedbackBox" placeholder="Laissez un commentaire (idée, bug, ressenti)…"></textarea>
  <div class="row">
    <button id="feedbackSend">Envoyer</button>
    <span class="muted" id="feedbackStatus"></span>
  </div>
  <p class="muted hint">Les commentaires sont enregistrés (classe/utilisateur, persona courant, datés) dans R2 via <code>/api/save</code>.</p>
</div>

    </section>
  </main>


  <!-- Overlay de boot (préchargement immersif) -->
  <div id="boot" style="position:fixed;inset:0;display:none;place-items:center;background:color-mix(in srgb, Canvas, CanvasText 5%);z-index:9999">
    <div style="width:min(520px,92vw);padding:16px;border:1px solid #ccc4;border-radius:12px;background:Canvas;color:CanvasText;box-shadow:0 10px 30px #0003;">
      <div id="boot-msg" style="margin-bottom:10px">Le forum s’éveille…</div>
      <div id="boot-bar" style="height:8px;background:#0001;border-radius:8px;overflow:hidden">
        <div style="height:100%;width:var(--p,0%);background:#0b5bf5"></div>
      </div>
    </div>
  </div>

  <!-- Script principal -->
  <script type="module" src="./assets/app.js?v=6"></script>

  <!-- Mini-script onglets (indépendant de app.js) -->
  <script>
  // gestion simple des onglets en bas + lazy-load de README.html
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabs    = document.querySelectorAll('.tab');
  let helpLoaded = false;

  function loadHelpOnce() {
    if (helpLoaded) return;
    const box = document.getElementById('helpContent');
    if (!box) return;
    fetch('./docs/README.html', { cache: 'no-store' })
      .then(r => r.ok ? r.text() : Promise.reject(new Error('README introuvable')))
      .then(html => { box.innerHTML = html; helpLoaded = true; })
      .catch(err => {
        box.innerHTML = '<p style="color:tomato">Impossible de charger <code>docs/README.html</code> : ' + (err.message || err) + '</p>';
      });
  }

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.tab;
      tabBtns.forEach(b => b.classList.toggle('active', b === btn));
      tabs.forEach(t => t.classList.toggle('active', t.id === id));
      if (id === 'help-tab') loadHelpOnce();
    });
  });

  if (document.querySelector('.tab.active#help-tab')) loadHelpOnce();
</script>

</body>
</html>
